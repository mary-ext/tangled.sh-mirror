{{ define "timeline/fragments/timeline" }}
    <div class="py-4">
        <div class="px-6 pb-4">
            <p class="text-xl font-bold dark:text-white">Timeline</p>
        </div>

        <div class="flex flex-col gap-4">
          {{ range $i, $e := .Timeline }}
            <div class="relative">
              {{ if ne $i 0 }}
                <div class="absolute left-8 -top-4 w-px h-4 bg-gray-300 dark:bg-gray-600"></div>
              {{ end }}
              {{ with $e }}
                <div class="flex flex-col divide-y divide-gray-200 dark:divide-gray-700 border border-gray-200 dark:border-gray-700 rounded-sm">
                  {{ if .Repo }}
                    {{ template "timeline/fragments/repoEvent" (list $ .Repo .Source) }}
                  {{ else if .Star }}
                    {{ template "timeline/fragments/starEvent" (list $ .Star) }}
                  {{ else if .Follow }}
                    {{ template "timeline/fragments/followEvent" (list $ .) }}
                  {{ end }}
                </div>
              {{ end }}
            </div>
          {{ end }}
        </div>
    </div>
{{ end }}

{{ define "timeline/fragments/repoEvent" }}
  {{ $root := index . 0 }}
  {{ $repo := index . 1 }}
  {{ $source := index . 2 }}
  {{ $userHandle := resolve $repo.Did }}
    <div class="pl-6 py-2 bg-white dark:bg-gray-800 text-gray-600 dark:text-gray-300 flex flex-wrap items-center gap-2 text-sm">
      {{ template "user/fragments/picHandleLink" $repo.Did }}
      {{ with $source }}
        {{ $sourceDid := resolve .Did }}
        forked
        <a href="/{{ $sourceDid }}/{{ .Name }}"class="no-underline hover:underline">
            {{ $sourceDid }}/{{ .Name }}
        </a>
        to
        <a href="/{{ $userHandle }}/{{ $repo.Name }}" class="no-underline hover:underline">{{ $repo.Name }}</a>
      {{ else }}
        created
        <a href="/{{ $userHandle }}/{{ $repo.Name }}" class="no-underline hover:underline">
          {{ $repo.Name }}
        </a>
      {{ end }}
      <span class="text-gray-700 dark:text-gray-400 text-xs">{{ template "repo/fragments/time" $repo.Created }}</span>
    </div>
  {{ with $repo }}
    {{ template "user/fragments/repoCard" (list $root . true) }}
  {{ end }}
{{ end }}

{{ define "timeline/fragments/starEvent" }}
  {{ $root := index . 0 }}
  {{ $star := index . 1 }}
  {{ with $star }}
    {{ $starrerHandle :=  resolve .StarredByDid }}
    {{ $repoOwnerHandle :=  resolve .Repo.Did }}
    <div class="pl-6 py-2 bg-white dark:bg-gray-800 text-gray-600 dark:text-gray-300 flex flex-wrap items-center gap-2 text-sm">
        {{ template "user/fragments/picHandleLink" $starrerHandle }}
        starred
        <a href="/{{ $repoOwnerHandle }}/{{ .Repo.Name }}" class="no-underline hover:underline">
          {{ $repoOwnerHandle | truncateAt30 }}/{{ .Repo.Name }}
        </a>
        <span class="text-gray-700 dark:text-gray-400 text-xs">{{ template "repo/fragments/time" .Created }}</span>
    </div>
    {{ with .Repo }}
      {{ template "user/fragments/repoCard" (list $root . true) }}
    {{ end }}
  {{ end }}
{{ end }}

{{ define "timeline/fragments/followEvent" }}
  {{ $root := index . 0 }}
  {{ $event := index . 1 }}
  {{ $follow := $event.Follow }}
  {{ $profile := $event.Profile }}
  {{ $stat := $event.FollowStats }}

  {{ $userHandle :=  resolve $follow.UserDid }}
  {{ $subjectHandle :=  resolve $follow.SubjectDid }}
  <div class="pl-6 py-2 bg-white dark:bg-gray-800 text-gray-600 dark:text-gray-300 flex flex-wrap items-center gap-2 text-sm">
      {{ template "user/fragments/picHandleLink" $userHandle }}
      followed
      {{ template "user/fragments/picHandleLink" $subjectHandle }}
      <span class="text-gray-700 dark:text-gray-400 text-xs">{{ template "repo/fragments/time" $follow.FollowedAt }}</span>
  </div>
  <div class="py-4 px-6 drop-shadow-sm rounded bg-white dark:bg-gray-800 flex flex-col md:flex-row md:items-center gap-4">
    <div class="flex items-center gap-4 flex-1">
      <div class="flex-shrink-0 max-h-full w-24 h-24">
        <img alt="" class="object-cover rounded-full p-2" src="{{ fullAvatar $subjectHandle }}" />
      </div>

      <div class="flex-1 min-h-0 justify-around flex flex-col">
        <a href="/{{ $subjectHandle }}">
          <span class="font-bold dark:text-white overflow-hidden text-ellipsis whitespace-nowrap max-w-full">{{ $subjectHandle | truncateAt30 }}</span>
        </a>
        {{ with $profile }}
          {{ with .Description }}
            <p class="text-sm pb-2 md:pb-2">{{.}}</p>
          {{ end }}
        {{ end }}
        {{ with $stat }}
          <div class="text-sm flex items-center gap-2 my-2 overflow-hidden text-ellipsis whitespace-nowrap max-w-full">
            <span class="flex-shrink-0">{{ i "users" "size-4" }}</span>
            <span id="followers"><a href="/{{ $subjectHandle }}?tab=followers">{{ .Followers }} followers</a></span>
            <span class="select-none after:content-['Â·']"></span>
            <span id="following"><a href="/{{ $subjectHandle }}?tab=following">{{ .Following }} following</a></span>
          </div>
        {{ end }}
      </div>
    </div>
    
    {{ if and $root.LoggedInUser (ne $event.FollowStatus.String "IsSelf") }}
      <div class="flex-shrink-0 w-fit ml-auto">
        {{ template "user/fragments/follow" (dict "UserDid" $follow.SubjectDid "FollowStatus" $event.FollowStatus) }}
      </div>
    {{ end }}
  </div>
{{ end }}
